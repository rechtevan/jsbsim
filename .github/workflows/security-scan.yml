name: Security Scanning

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  # CodeQL analysis for C++ and Python
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      security-events: write
    steps:
      - name: Checkout JSBSim
        uses: actions/checkout@v5

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp, python
          queries: +security-and-quality

      - name: Build for CodeQL
        run: |
          mkdir -p build
          cd build
          cmake -DBUILD_PYTHON_MODULE=OFF ..
          make -j$(nproc)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:cpp"

  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout JSBSim
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install safety
        run: pip install safety

      - name: Check Python dependencies
        run: |
          # Create requirements from known dependencies
          echo "numpy" > /tmp/requirements.txt
          echo "pandas" >> /tmp/requirements.txt
          echo "scipy" >> /tmp/requirements.txt
          echo "cython" >> /tmp/requirements.txt

          safety check -r /tmp/requirements.txt --output text 2>&1 || true

      - name: Dependency Summary
        run: |
          echo "## Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scanned Python dependencies for known vulnerabilities." >> $GITHUB_STEP_SUMMARY

  # Secret detection
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout JSBSim
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        run: |
          detect-secrets scan --all-files --baseline .secrets.baseline 2>&1 || true

      - name: Check for new secrets
        run: |
          if [ -f ".secrets.baseline" ]; then
            detect-secrets audit .secrets.baseline --report 2>&1 || true
          fi

      - name: Secret Scan Summary
        run: |
          echo "## Secret Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scanned codebase for hardcoded secrets and credentials." >> $GITHUB_STEP_SUMMARY

  # SAST with Semgrep
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout JSBSim
        uses: actions/checkout@v5

      - name: Run Semgrep
        run: |
          semgrep scan --config auto --config p/security-audit \
            --exclude="build" --exclude="*.xml" \
            --json --output semgrep-results.json \
            src/ python/ tests/ 2>&1 || true

      - name: Parse Semgrep results
        run: |
          echo "## Semgrep SAST Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "semgrep-results.json" ]; then
            finding_count=$(cat semgrep-results.json | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('results', [])))" 2>/dev/null || echo "0")
            echo "Found $finding_count potential issues." >> $GITHUB_STEP_SUMMARY
          else
            echo "No results file generated." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout JSBSim
        uses: actions/checkout@v5

      - name: Check license headers
        run: |
          echo "## License Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count files with GPL header
          gpl_count=$(grep -r "GNU General Public License" src/ --include="*.cpp" --include="*.h" -l 2>/dev/null | wc -l || echo "0")
          total_cpp=$(find src/ -name "*.cpp" -o -name "*.h" | wc -l)

          echo "C++ files with GPL header: $gpl_count / $total_cpp" >> $GITHUB_STEP_SUMMARY

          # Check for COPYING file
          if [ -f "COPYING" ]; then
            echo "COPYING file: Present" >> $GITHUB_STEP_SUMMARY
          else
            echo "COPYING file: Missing" >> $GITHUB_STEP_SUMMARY
          fi
