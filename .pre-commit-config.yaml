# Pre-commit hooks for JSBSim
# See https://pre-commit.com for more information
#
# SPDX-FileCopyrightText: 2025 Booz Allen Hamilton Inc.
# SPDX-License-Identifier: LGPL-2.1-or-later
#
# Usage:
#   pre-commit install                 # Install git hooks
#   pre-commit run --all-files         # Run on all files
#   pre-commit run <hook-id>           # Run specific hook
#   git commit --no-verify             # Skip hooks (emergency use only)
#
# To update hooks: pre-commit autoupdate

repos:
  # =============================================================================
  # General Hooks (All Files)
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # File formatting
      - id: trailing-whitespace
        name: Trim trailing whitespace
        exclude: '\.md$|\.txt$'  # Exclude markdown and text files

      - id: end-of-file-fixer
        name: Ensure files end with newline
        exclude: '\.png$|\.jpg$|\.gif$|\.csv$'

      - id: mixed-line-ending
        name: Fix mixed line endings
        args: ['--fix=lf']  # Force LF (Unix style)

      # File checks
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=1000']  # Warn if file > 1MB

      - id: check-case-conflict
        name: Check for case conflicts

      - id: check-merge-conflict
        name: Check for merge conflict markers

      - id: check-symlinks
        name: Check for broken symlinks

      # Code checks
      - id: check-yaml
        name: Check YAML syntax
        exclude: '.*/\.github/.*'  # Skip GitHub workflows if needed

      - id: check-json
        name: Check JSON syntax

      - id: check-xml
        name: Check XML syntax

      - id: check-toml
        name: Check TOML syntax

      # Security
      - id: detect-private-key
        name: Detect private keys

  # =============================================================================
  # Python Hooks
  # =============================================================================
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        name: Format Python code (black)
        language_version: python3
        types: [python]

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.2.0
    hooks:
      - id: ruff
        name: Lint Python code (ruff)
        args: [--fix, --exit-non-zero-on-fix]
        types: [python]

  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: Check Python style (flake8)
        types: [python]
        args: ['--max-line-length=100', '--extend-ignore=E203,W503']
        # E203: whitespace before ':' (conflicts with black)
        # W503: line break before binary operator (conflicts with black)

  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: Sort Python imports (isort)
        types: [python]
        args: ['--profile=black', '--line-length=100']

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: Type check Python (mypy)
        types: [python]
        additional_dependencies: [types-setuptools, pandas-stubs]
        args: ['--ignore-missing-imports', '--no-strict-optional']
        exclude: 'tests/|setup.py'  # Skip tests for now

  # =============================================================================
  # C++ Hooks (Optional - install tools first)
  # =============================================================================
  # Uncomment after installing clang-format:
  # sudo apt-get install clang-format
  #
  # - repo: https://github.com/pre-commit/mirrors-clang-format
  #   rev: v17.0.6
  #   hooks:
  #     - id: clang-format
  #       name: Format C++ code (clang-format)
  #       types: [c++]
  #       args: ['-i', '--style=file']

  # Uncomment after installing cppcheck:
  # sudo apt-get install cppcheck
  #
  # - repo: https://github.com/pocc/pre-commit-hooks
  #   rev: v1.3.5
  #   hooks:
  #     - id: cppcheck
  #       name: Static analysis for C++ (cppcheck)
  #       types: [c++]
  #       args: ['--enable=warning,style,performance,portability', '--suppress=missingInclude']

  # =============================================================================
  # MATLAB/Octave Hooks (Custom)
  # =============================================================================
  - repo: local
    hooks:
      - id: octave-syntax-check
        name: Check MATLAB/Octave syntax
        entry: bash -c 'for file in "$@"; do octave --eval "try; source(\"$file\"); catch; exit(1); end" || exit 1; done' --
        language: system
        types: [file]
        files: '\.m$'
        pass_filenames: true

  # =============================================================================
  # Julia Hooks (Julia installed at ~/.local/julia/bin/julia)
  # =============================================================================
  - repo: local
    hooks:
      - id: julia-syntax-check
        name: Check Julia syntax
        entry: bash -c 'for file in "$@"; do ~/.local/julia/bin/julia --check-bounds=yes -e "include(\"$file\")" || exit 1; done' --
        language: system
        types: [file]
        files: '\.jl$'
        pass_filenames: true

  # =============================================================================
  # XML Validation (Aircraft/Config Files)
  # =============================================================================
  - repo: local
    hooks:
      - id: validate-jsbsim-xml
        name: Validate JSBSim XML files
        entry: bash -c 'for file in "$@"; do xmllint --noout "$file" || exit 1; done' --
        language: system
        types: [xml]
        files: '^(aircraft|engine|systems)/.*\.xml$'
        pass_filenames: true

  # =============================================================================
  # CMake Formatting
  # =============================================================================
  - repo: https://github.com/cheshirekow/cmake-format-precommit
    rev: v0.6.13
    hooks:
      - id: cmake-format
        name: Format CMake files
        types: [cmake]

      - id: cmake-lint
        name: Lint CMake files
        types: [cmake]

  # =============================================================================
  # Markdown Linting
  # =============================================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.39.0
    hooks:
      - id: markdownlint
        name: Lint Markdown files
        args: ['--fix', '--disable', 'MD013', 'MD033', 'MD041']
        # MD013: Line length
        # MD033: Inline HTML
        # MD041: First line not h1

  # =============================================================================
  # Code Coverage (Manual - Run with: pre-commit run cpp-coverage-check)
  # =============================================================================
  - repo: local
    hooks:
      - id: cpp-coverage-check
        name: Check C++ code coverage (manual)
        entry: scripts/check-cpp-coverage.sh
        language: system
        pass_filenames: false
        stages: [manual]
        always_run: true
        verbose: true

  # =============================================================================
  # Security Checks
  # =============================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: Detect secrets in code
        args: ['--baseline', '.secrets.baseline']
        exclude: '\.local/|build/|build-coverage/'

# =============================================================================
# Pre-commit CI Configuration
# =============================================================================
ci:
  autofix_prs: true
  autoupdate_schedule: weekly
